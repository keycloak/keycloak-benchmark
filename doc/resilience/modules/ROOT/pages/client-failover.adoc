= Client Failover
:description: This guide describes how to achieve automatic client-failover when a Keycloak deployment on a given site fails.

{description}

== Route 53
To provide client failover we can leverage https://aws.amazon.com/route53/[AWS Route 53]'s https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/dns-failover-configuring.html[DNS failover]
capabilities to automatically re-route traffic when the primary site is down.

We're going to define 3 subdomains for our root domain, in this case `keycloak-benchmark.com`.

`site1.keycloak-benchmark.com`:: Subdomain for Keycloak site 1
`site2.keycloak-benchmark.com`:: Subdomain for Keycloak site 2
`client.keycloak-benchmark.com`:: Subdomain used by Keycloak clients, that will automatically failover from 1 to 2
in the event of a failure.

== Prerequisites
* A Route 53 Hosted Zone for your domain
** https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html[Existing Domain]
** https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/dns-configuring-new-domain.html[New Domain]
* Keycloak deployed on multiple ROSA clusters with Active/Passive, or Active/Active replication xsite enabled.

NOTE: A hosted zone already exists for keycloak-benchmark.com

== OpenShift Configuration
In order to use the Keycloak UI via `client.keycloak-benchmark.com` we need to deploy Keycloak with this as the expected
hostname value, or with strict hostname checking disabled. Specify `spec.hostname.hostname: client.keycloak-benchmark.com`
in the Keycloak CR ensures that the required Route is exposed.

In order to route traffic to a given site based upon its health, we first need to expose a health endpoint externally
via an OpenShift Route. To ensure that requests are correctly routed, it's important that we set the `spec.host` field
to the correct subdomain for a given site, for example Site1 would set `spec.host: site1.keycloak-benchmark.com`.

The following yaml needs to be applied in the Keycloak namespace in each site to be exposed, with the `spec.host` field
of the `aws-health-route` Route updated to use the site specific domain.
[source,yaml]
----
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: aws-health-route
spec:
  host: site1.keycloak-benchmark.com # Replace with site specific domain
  port:
    targetPort: https
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: passthrough
  to:
    kind: Service
    name: keycloak-service # Replace keycloak with the name of your Keycloak CR
----

== Health Checks
So that Route 53 can detect failures, we need to create a https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/dns-failover.html[Health Check]
for each of the Keycloak sites.

[.shadow]
image::health-check.png[Route 53 Health Check]

== Hosted Zone Records
Within our Route 53 Hosted Zone, we need to define 3 subdomains for our root domain keycloak-benchmark.com.

`site1.keycloak-benchmark.com`:: Subdomain for Keycloak site 1
`site2.keycloak-benchmark.com`:: Subdomain for Keycloak site 2
`client.keycloak-benchmark.com`:: Subdomain used by Keycloak clients, that will automatically failover from 1 to 2
in the event of a failure.

=== Site Records
For subdomains 1 & 2 we need to create an "A" record, with Alias=true, traffic routed to "Alias to Application and Classic Load Balancer"
and "Simple Routing" enabled. It's necessary to select the AWS region hosting the ROSA cluster and then select the
loadbalancer associated with your cluster.

[.shadow]
image::site-record.png[Site Record]

NOTE: You can determine the loadbalancer associated with your ROSA cluster by going to the AWS EC2 console -> Load Balancers
section and inspecting the "classic" loadbalancers. On an individual loadbalancer screen you can see the name of the
associated ROSA cluster by clicking on the "Instances" tab.

=== Failover Record
For client domain it's necessary for us to create two Records with the "Failover" Routing Policy.

1. Define the primary record for `client.keycloak-benchmark.com`
** Select Route traffic to "Alias to another record in this hosted zone" and choose the site1 record.
** Define the Routing Policy as "Failover" and the Failover record type as "Primary".
** Specify the Health Check defined earlier for Site1.
** Provide a unique record id, e.g. client-failover-site1.

2. Click "Add another record"

3. Define the secondary record for `client.keycloak-benchmark.com`
** Select Route traffic to "Alias to another record in this hosted zone" and choose the site1 record.
** Define the Routing Policy as "Failover" and the Failover record type as "Secondary".
** Specify the Health Check defined earlier for Site2.
** Provide a unique record id, e.g. client-failover-site2.

4. Click "Create Records"

[.shadow]
image::failover-record.png[Client Failover Record]

== Verifying Setup
It should be possible to login to site1 via `site1.keycloak-benchmark.com` and `client.keycloak-benchmark.com` and site2
via `site2.keycloak-benchmark.com`.

== Testing Failover
To test failover from site1 to site2, do the following:

1. Verify that `client.keycloak-benchmark.com` connects to site1.
2. Login to the site1 ROSA cluster and delete the `direct-route` Route from the keycloak namespace.
3. Wait ~ 30 seconds for the Health Checks to determine that `site1.keycloak-benchmark.com` is no longer health.
4. Reconnect to `client.keycloak-benchmark.com` and verify that site2 is loaded.
